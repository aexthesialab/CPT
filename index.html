<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>ÆX CPT . Continuous Performance Task</title>

<style>
    body {
        background: #0d0d0d;
        color: #ffffff;
        font-family: Arial, sans-serif;
        text-align: center;
        padding-top: 80px;
        margin: 0;
    }

    h1 {
        font-size: 52px;
        margin-bottom: 30px;
    }

    h2 {
        font-size: 32px;
        margin-top: 10px;
        margin-bottom: 30px;
    }

    h3 {
        font-size: 22px;
        margin-top: 40px;
        margin-bottom: 15px;
    }

    #instructions {
        font-size: 20px;
        margin-bottom: 30px;
    }

    #letter {
        font-size: 100px;
        font-weight: bold;
        margin-bottom: 40px;
        min-height: 120px;
    }

    .btn {
        font-size: 24px;
        padding: 14px 32px;
        margin: 8px;
        background: #1b1b1b;
        border: 2px solid #5fffd2;
        color: #5fffd2;
        cursor: pointer;
        border-radius: 8px;
    }

    .btn:hover {
        background: #5fffd2;
        color: #000000;
    }

    #startBtn {
        margin-top: 30px;
    }

    #result {
        font-size: 20px;
        margin-top: 40px;
        line-height: 1.6;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        text-align: left;
    }

    #result p {
        margin: 6px 0;
    }

    #legend ul {
        text-align: left;
        display: inline-block;
        margin: 0;
        padding-left: 20px;
    }

    #legend li {
        margin-bottom: 6px;
    }

    .badge-container {
        margin-top: 25px;
        margin-bottom: 10px;
    }

    .badge-label {
        font-size: 18px;
        margin-bottom: 8px;
    }

    .badge-pill {
        display: inline-block;
        padding: 8px 18px;
        border-radius: 999px;
        font-size: 16px;
        font-weight: bold;
    }

    .badge-good {
        background-color: #1f8a70;
        color: #ffffff;
    }

    .badge-normal {
        background-color: #b38f1b;
        color: #000000;
    }

    .badge-high {
        background-color: #b3261e;
        color: #ffffff;
    }

    .note {
        font-size: 12px;
        margin-top: 35px;
        color: #cccccc;
        text-align: center;
    }
</style>
</head>

<body>

<h1>Continuous Performance Task</h1>

<div id="instructions">
    Premi "Inizia" per cominciare.<br>
    Premi la barra spaziatrice solo quando compare la lettera <strong>X</strong>.
</div>

<button id="startBtn" class="btn">Inizia</button>

<div id="letter" style="display:none;"></div>

<div id="result"></div>

<script>
/* ------------------------------
   CONFIGURAZIONE
--------------------------------*/

// sostituisci con la URL della tua Web App Google Apps Script
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxcXMBobDuMtpQDfazA1cXQeyIJy7ONzcRSfhXaqXlsKFK7iq9jAIuDOwGjqbZwH_qg/exec";

const NUM_TRIALS = 200;          // puoi cambiare se lo vuoi più corto o più lungo
const TARGET_PROB = 0.3;         // circa 30 percent X
const STIM_MS = 300;
const ISI_MS = 700;

const NON_TARGETS = "ABCDEFGHJKLMNPQRTUVWYZ".split("");

let trials = [];
let currentTrial = 0;
let trialStartTime = 0;
let respondedThisTrial = false;
let running = false;

/* struttura di ciascun trial:
   {
     isTarget: bool,
     responded: bool,
     rt: number | null,
     correct: bool | null
   }
*/

/* ------------------------------
   UTILITY
--------------------------------*/

function avg(arr) {
    if (!arr.length) return 0;
    return arr.reduce((a, b) => a + b, 0) / arr.length;
}

function interpretCPT(accuracyPercent, omissions, commissions) {
    // semplice logica di interpretazione
    if (accuracyPercent >= 90 && commissions <= 2) {
        return {
            label: "Ottima attenzione sostenuta e controllo inibitorio",
            cssClass: "badge-good"
        };
    } else if (accuracyPercent >= 75) {
        return {
            label: "Performance nella norma. possibili fluttuazioni di attenzione",
            cssClass: "badge-normal"
        };
    } else {
        return {
            label: "Calo di attenzione o risposte impulsive più frequenti in questo test",
            cssClass: "badge-high"
        };
    }
}

/* ------------------------------
   AVVIO TEST
--------------------------------*/

document.getElementById("startBtn").onclick = () => {
    document.getElementById("instructions").style.display = "none";
    document.getElementById("startBtn").style.display = "none";

    document.getElementById("letter").style.display = "block";

    window.addEventListener("keydown", handleKeydown);
    running = true;
    nextTrial();
};

/* ------------------------------
   GESTIONE TASTIERA
--------------------------------*/

function handleKeydown(e) {
    if (!running) return;
    if (e.code !== "Space" && e.key !== " ") return;
    if (respondedThisTrial) return;

    respondedThisTrial = true;
    const rt = Math.round(performance.now() - trialStartTime);

    const t = trials[currentTrial - 1];
    t.responded = true;
    t.rt = rt;
    t.correct = t.isTarget;   // è corretto solo se è un target
}

/* ------------------------------
   NUOVO TRIAL
--------------------------------*/

function nextTrial() {
    if (currentTrial >= NUM_TRIALS) {
        finishTest();
        return;
    }

    respondedThisTrial = false;

    const isTarget = Math.random() < TARGET_PROB;
    let letter = "X";
    if (!isTarget) {
        letter = NON_TARGETS[Math.floor(Math.random() * NON_TARGETS.length)];
    }

    const letterDiv = document.getElementById("letter");
    letterDiv.innerHTML = letter;

    trialStartTime = performance.now();

    trials.push({
        isTarget: isTarget,
        responded: false,
        rt: null,
        correct: null
    });

    currentTrial++;

    // mostra lettera per STIM_MS, poi schermo vuoto per ISI_MS
    setTimeout(() => {
        letterDiv.innerHTML = "";
        setTimeout(() => {
            nextTrial();
        }, ISI_MS);
    }, STIM_MS);
}

/* ------------------------------
   FINE TEST
--------------------------------*/

function finishTest() {
    running = false;
    window.removeEventListener("keydown", handleKeydown);
    document.getElementById("letter").style.display = "none";

    // calcolo metriche
    let targetCount = 0;
    let hits = 0;
    let omissions = 0;
    let commissions = 0;
    let rtsHits = [];

    trials.forEach(t => {
        if (t.isTarget) {
            targetCount++;
            if (t.responded && t.correct) {
                hits++;
                if (t.rt != null) rtsHits.push(t.rt);
            } else if (!t.responded) {
                omissions++;
            }
        } else {
            if (t.responded) {
                commissions++;
            }
        }
    });

    const accuracyPercent = targetCount > 0 ? Math.round((hits / targetCount) * 100) : 0;
    const meanRtHits = rtsHits.length ? Math.round(avg(rtsHits)) : 0;

    const sessionId = "AEX-" + Date.now();
    const interpretation = interpretCPT(accuracyPercent, omissions, commissions);

    // UI risultati
    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = `
        <h2>Risultati</h2>

        <p><strong>Tempo medio di risposta ai target corretti. </strong>${meanRtHits || "-"} ms</p>
        <p><strong>Errori di omissione (target senza risposta). </strong>${omissions}</p>
        <p><strong>Errori di commissione (risposte a non target). </strong>${commissions}</p>
        <p><strong>Accuratezza sui target. </strong>${accuracyPercent} percent</p>

        <div class="badge-container">
            <div class="badge-label">Sintesi del tuo profilo in questo test</div>
            <div class="badge-pill ${interpretation.cssClass}">
                ${interpretation.label}
            </div>
        </div>

        <div id="legend">
            <h3>Come leggere questi dati</h3>
            <ul>
                <li>Questo compito richiede di mantenere l'attenzione nel tempo su stimoli ripetitivi.</li>
                <li>Un tempo di reazione più basso indica risposte più rapide ai target rilevanti.</li>
                <li>Molte omissioni possono indicare cali di attenzione o affaticamento cognitivo.</li>
                <li>Molte commissioni possono indicare tendenza alla risposta impulsiva.</li>
            </ul>
        </div>

        <p class="note">
            I dati di questo test sono salvati in forma anonima e aggregata.  
            non raccogliamo nome, email o altri dati che permettano l'identificazione personale.  
            il tuo codice di sessione è <strong>${sessionId}</strong> e viene usato solo per analisi statistiche interne.
        </p>
    `;

    // payload per Google Sheet (una sola riga per sessione)
    const payload = {
        sessionId: sessionId,
        meanRtHits: meanRtHits,
        omissions: omissions,
        commissions: commissions,
        accuracy: accuracyPercent,
        extra: ""
    };

    fetch(WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify(payload)
    }).catch(err => {
        console.error("Errore nell'invio al foglio Google:", err);
    });
}
</script>

</body>
</html>

